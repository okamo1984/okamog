---
title: モノリスからマイクロサービスへ 3章
publish_date: 2022-07-18
tags: [読書]
---

3章はモノリスの分割がテーマ。主にパターンの説明だった。分割は「モノリスの実装を特定のサービスを利用するように変更すること」と理解した。

## ストラングラーパターン

- 利用するサービスをプロキシで切り替えるパターン。
- 通信プロトコルの変更など実装の外側で制御できる場合に効果的。
- 非同期の場合は、コンテンツベースのルーティングや選択的消費が候補。
  - 前者は、コンテンツごとにキューが増やすのではなく、コンテンツルータで制御することを最初に考える。
  - 後者は、コンテンツが増えると消費しないもののロールバックと消費したものの完了処理を同時に行うため煩雑になりやすいので、コンテンツが少ない場合に採用を考える。

## UI合成

- UIを各サービスで管理して、読み込み時に合成するパターン。
- マイクロフロントエンドに通じる。

## 抽象化によるブランチ

- ブランチを分けて管理するのではなく、メインブランチで実装の抽象を利用するように変更して、新しい抽象の実装に切り替えていくパターン。
- [フィーチャフラグ](https://martinfowler.com/articles/feature-toggles.html)で切り替えるのが良い。
  - 切り替えが完了したらフラグは削除する。

## 同時実行

- 既存の実装と新しい実装を同時に実行して、新しい実装が想定通りの動作をしていることを確認する。
- メール送信など重複して実行したくないものは、スパイなどで実行したことを記録すると良い。

## デコレーティングコラボレーター

- 実装に処理を追加するときに使用するパターン。
- プロキシを利用してモノリスからのレスポンスを受け取って追加の処理を実施する。
- モノリスからのリクエストとレスポンスから必要な情報を取得できない場合はよく考えて利用する。

## 変更データキャプチャ

- データストアで行われた変更に反応するパターン。
- データベーストリガーでデータが変更されたのをトリガーにして処理する。
- トランザクションログを監視して変更されたデータを処理する。
- バッチである時間から変更されたデータを取得して処理する。

## パターンの使い所

- ストラングラーパターンが第一候補。
- 実装を変更しやすいのであれば抽象化によるブランチの採用を考える。
- 切り替えのリスクが高い場合は同時実行の採用を考える。
- 上記で解決できない場合はデコレーティングコラボレーターや変更データキャプチャの採用を考える。
